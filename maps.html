<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HouzzHunt Property Map</title>
  <link rel="shortcut icon" href="assets/images/logo/favicon.png" type="image/x-icon">
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+zWATbFveLLNqwo1cAdnxu1VNnjkCkVpWm5H0ao0M="
    crossorigin="anonymous"
  />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Hind+Madurai:wght@300;400;500;600;700&display=swap');

    :root {
      --offplan-colour: #f0a500;
      --buy-colour: #0f635c;
      --rent-colour: #1f7a8c;
      --sidebar-width: min(420px, 100%);
      --background: #0b1b2b;
      --panel-bg: rgba(11, 27, 43, 0.82);
      --panel-border: rgba(255, 255, 255, 0.08);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.72);
      --accent: #edbb68;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Hind Madurai", sans-serif;
      background: var(--background);
      color: var(--text-primary);
      overflow: hidden;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .map-app {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    .leaflet-container {
      font: 14px "Hind Madurai", sans-serif;
      background: var(--background);
    }

    .leaflet-control-zoom {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
    }

    .leaflet-control-zoom a {
      background: rgba(11, 27, 43, 0.92);
      color: var(--text-primary);
      border-bottom: 1px solid var(--panel-border);
    }

    .leaflet-control-zoom a:last-child {
      border-bottom: none;
    }

    .leaflet-popup-content-wrapper,
    .leaflet-popup-tip {
      background: rgba(13, 30, 48, 0.92);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .leaflet-popup-content {
      margin: 14px 18px;
      min-width: 220px;
    }

    .sidebar {
      position: relative;
      z-index: 2;
      width: var(--sidebar-width);
      max-width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: var(--panel-bg);
      backdrop-filter: blur(16px);
      padding: 24px;
      border-right: 1px solid var(--panel-border);
      overflow: hidden;
    }

    .sidebar-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 16px;
    }

    .sidebar-header h1 {
      font-size: 22px;
      font-weight: 600;
      margin: 0;
    }

    .sidebar-header span {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .filters {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 16px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .filter-group label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      user-select: none;
    }

    .filter-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .search-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: rgba(12, 28, 45, 0.6);
      color: var(--text-primary);
      font-size: 14px;
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .property-summary {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .property-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .property-card {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 14px 16px;
      background: rgba(13, 30, 48, 0.85);
      border-radius: 14px;
      border: 1px solid transparent;
      transition: border-color 0.2s ease, background 0.2s ease;
      cursor: pointer;
    }

    .property-card[data-active="true"] {
      border-color: var(--accent);
      background: rgba(237, 187, 104, 0.18);
    }

    .property-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .property-meta {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .property-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      background: rgba(255, 255, 255, 0.1);
    }

    .property-tag.offplan { background: rgba(240, 165, 0, 0.18); color: var(--offplan-colour); }
    .property-tag.buy { background: rgba(15, 99, 92, 0.18); color: var(--buy-colour); }
    .property-tag.rent { background: rgba(31, 122, 140, 0.18); color: var(--rent-colour); }

    .property-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .property-actions a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }

    .empty-state {
      padding: 24px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
      background: rgba(13, 30, 48, 0.85);
      border-radius: 16px;
      border: 1px solid var(--panel-border);
    }

    .mapboxgl-popup-content {
      font-family: "Hind Madurai", sans-serif;
      background: rgba(13, 30, 48, 0.9);
      color: var(--text-primary);
      border-radius: 14px;
      padding: 16px 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    .mapboxgl-popup-content h3 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .mapboxgl-popup-content .popup-meta {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mapboxgl-popup-content a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
      font-size: 13px;
    }

    .marker {
      width: 26px;
      height: 26px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      border: 2px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);
      cursor: pointer;
    }

    .marker::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 10px;
      height: 10px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      transform: translate(-50%, -50%) rotate(45deg);
    }

    .marker.offplan { background: var(--offplan-colour); }
    .marker.buy { background: var(--buy-colour); }
    .marker.rent { background: var(--rent-colour); }

    .overlay-message {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(13, 30, 48, 0.88);
      border-radius: 16px;
      padding: 24px 30px;
      color: var(--text-primary);
      font-size: 15px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      text-align: center;
      max-width: 380px;
      z-index: 3;
    }

    .overlay-message strong {
      display: block;
      margin-bottom: 8px;
      font-size: 17px;
    }

    @media (max-width: 1024px) {
      .map-app {
        flex-direction: column;
      }

      .sidebar {
        position: relative;
        width: 100%;
        height: auto;
        max-height: 50vh;
      }

      .property-list {
        max-height: 40vh;
      }
    }

    @media (max-width: 600px) {
      .sidebar {
        padding: 18px 16px;
      }

      .sidebar-header h1 {
        font-size: 18px;
      }

      .property-card {
        padding: 12px 14px;
      }

      .property-title {
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="map-app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>Explore HouzzHunt Properties</h1>
        <span>Select a property to view its details on the map.</span>
      </div>

      <div class="filters">
        <input class="search-input" type="search" placeholder="Search by name or location" id="searchInput" />
        <div class="filter-group" id="categoryFilters"></div>
        <div class="property-summary" id="propertySummary"></div>
      </div>

      <div class="property-list" id="propertyList"></div>
    </aside>

    <div id="map"></div>
    <div class="overlay-message" id="overlayMessage" hidden>
      <strong>Map unavailable</strong>
      <span id="overlayDetails">Unable to load the interactive map.</span>
    </div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="anonymous"
  ></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
    const state = {
      properties: [],
      filtered: [],
      markers: new Map(),
      activePropertyKey: null,
      map: null,
      mapLibrary: 'mapbox',
      categoryMeta: new Map([
        ['offplan', { label: 'Off-Plan', colour: getComputedStyle(document.documentElement).getPropertyValue('--offplan-colour') }],
        ['buy', { label: 'Buy', colour: getComputedStyle(document.documentElement).getPropertyValue('--buy-colour') }],
        ['rent', { label: 'Rent', colour: getComputedStyle(document.documentElement).getPropertyValue('--rent-colour') }],
      ]),
      enabledCategories: new Set(['offplan', 'buy', 'rent']),
      mapReady: false,
      accessToken: '',
    };

    const elements = {
      list: document.getElementById('propertyList'),
      summary: document.getElementById('propertySummary'),
      filters: document.getElementById('categoryFilters'),
      overlay: document.getElementById('overlayMessage'),
      overlayDetails: document.getElementById('overlayDetails'),
      search: document.getElementById('searchInput'),
      mapContainer: document.getElementById('map'),
    };

    fetch('property-map-data.php')
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to load property data.');
        }
        return response.json();
      })
      .then(payload => {
        state.accessToken = (payload.mapbox_access_token || '').trim();
        state.properties = Array.isArray(payload.properties)
          ? payload.properties.map(normaliseProperty)
          : [];

        buildCategoryFilters();
        applyFilters();

        if (!state.accessToken) {
          initialiseLeafletMap();
          return;
        }

        mapboxgl.accessToken = state.accessToken;
        initialiseMapbox();
      })
      .catch(() => {
        showOverlay('Map unavailable', 'We were unable to load the property dataset. Please try again later.');
      });

    function initialiseMapbox() {
      state.mapLibrary = 'mapbox';

      if (!state.properties.length) {
        showOverlay('Map unavailable', 'No properties with map locations were found.');
      }

      try {
        state.map = new mapboxgl.Map({
          container: elements.mapContainer,
          style: 'mapbox://styles/mapbox/satellite-streets-v12',
          center: [55.2708, 25.2048],
          zoom: 9.5,
          pitch: 55,
          bearing: -20,
          antialias: true,
        });
      } catch (error) {
        showOverlay('Map unavailable', 'The interactive map could not be initialised.');
        return;
      }

      state.map.addControl(new mapboxgl.NavigationControl({ showCompass: true }), 'top-right');
      state.map.on('load', () => {
        state.mapReady = true;
        hideOverlay();
        refreshMarkers();
      });

    function initialiseMap() {
      if (!state.properties.length) {
        showOverlay('Map unavailable', 'No properties with map locations were found.');
      }

      try {
        state.map = new mapboxgl.Map({
          container: elements.mapContainer,
          style: 'mapbox://styles/mapbox/satellite-streets-v12',
          center: [55.2708, 25.2048],
          zoom: 9.5,
          pitch: 55,
          bearing: -20,
          antialias: true,
        });
      } catch (error) {
        showOverlay('Map unavailable', 'The interactive map could not be initialised.');
        return;
      }

      state.map.addControl(new mapboxgl.NavigationControl({ showCompass: true }), 'top-right');
      state.map.on('load', () => {
        state.mapReady = true;
        refreshMarkers();
      });

      return googleMapsScriptPromise;
    }

    function initialiseLeafletMap() {
      state.mapLibrary = 'leaflet';

      if (typeof L === 'undefined') {
        showOverlay('Map unavailable', 'The map could not be initialised because the required libraries failed to load.');
        return;
      }

      try {
        state.map = L.map(elements.mapContainer, {
          zoomControl: false,
          attributionControl: false,
        });
      } catch (error) {
        showOverlay('Map unavailable', 'The interactive map could not be initialised.');
        return;
      }

      const tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
      });
      tiles.addTo(state.map);
      L.control.zoom({ position: 'topright' }).addTo(state.map);

      state.mapReady = true;
      hideOverlay();

      const coords = collectCoordinates();
      if (coords.length) {
        const bounds = L.latLngBounds(coords.map(({ latitude, longitude }) => [latitude, longitude]));
        state.map.fitBounds(bounds, { padding: [40, 40], maxZoom: 14 });
      } else {
        state.map.setView([25.2048, 55.2708], 9.5);
      }

      refreshMarkers();
    }

    function normaliseProperty(property) {
      const id = Number(property.id) || 0;
      const categoryKey = typeof property.category_key === 'string' ? property.category_key.toLowerCase() : '';
      const displayName = (property.display_name || property.title || '').trim();
      const location = (property.location || '').trim();
      const key = `${categoryKey}-${id}`;
      return {
        ...property,
        id,
        category_key: categoryKey,
        display_name: displayName || 'Untitled property',
        location,
        key,
        latitude: typeof property.latitude === 'number' ? property.latitude : Number(property.latitude),
        longitude: typeof property.longitude === 'number' ? property.longitude : Number(property.longitude),
        details_url: (property.details_url || '#').trim() || '#',
        price: (property.price || '').trim(),
        bedrooms: (property.bedrooms || '').trim(),
        property_type: (property.property_type || '').trim(),
      };
    }

    function buildCategoryFilters() {
      elements.filters.innerHTML = '';
      state.categoryMeta.forEach((meta, key) => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = state.enabledCategories.has(key);
        checkbox.dataset.category = key;
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            state.enabledCategories.add(key);
          } else {
            state.enabledCategories.delete(key);
          }
          applyFilters();
        });

        const swatch = document.createElement('span');
        swatch.style.width = '10px';
        swatch.style.height = '10px';
        swatch.style.borderRadius = '50%';
        swatch.style.background = meta.colour || 'var(--accent)';
        swatch.style.display = 'inline-flex';

        const text = document.createElement('span');
        text.textContent = meta.label;

        label.append(checkbox, swatch, text);
        elements.filters.appendChild(label);
      });

      if (!elements.search.dataset.bound) {
        elements.search.addEventListener('input', () => {
          applyFilters();
        });
        elements.search.dataset.bound = 'true';
      }
    }

    function applyFilters() {
      const query = elements.search.value.trim().toLowerCase();
      state.filtered = state.properties.filter((property) => {
        if (!state.enabledCategories.has(property.category_key)) {
          return false;
        }

        if (query !== '') {
          const haystack = `${property.display_name} ${property.location}`.toLowerCase();
          if (!haystack.includes(query)) {
            return false;
          }
        }

        return true;
      });

      renderSidebar(state.filtered);
      refreshMarkers();
    }

    function renderSidebar(properties) {
      elements.list.innerHTML = '';

      if (!properties.length) {
        elements.list.innerHTML = '<div class="empty-state">No properties match the current filters.</div>';
      } else {
        properties.forEach((property) => {
          const card = document.createElement('div');
          card.className = 'property-card';
          card.dataset.key = property.key;
          card.addEventListener('click', () => focusProperty(property.key));

          const title = document.createElement('div');
          title.className = 'property-title';
          title.textContent = property.display_name;

          const meta = document.createElement('div');
          meta.className = 'property-meta';

          const tag = document.createElement('span');
          tag.className = `property-tag ${property.category_key}`;
          tag.textContent = state.categoryMeta.get(property.category_key)?.label || 'Property';
          meta.appendChild(tag);

          if (property.location) {
            const location = document.createElement('span');
            location.textContent = property.location;
            meta.appendChild(location);
          }

          if (property.property_type) {
            const type = document.createElement('span');
            type.textContent = property.property_type;
            meta.appendChild(type);
          }

          const actions = document.createElement('div');
          actions.className = 'property-actions';

          if (property.price) {
            const price = document.createElement('span');
            price.textContent = property.price;
            actions.appendChild(price);
          }

          if (property.bedrooms) {
            const bedrooms = document.createElement('span');
            bedrooms.textContent = `${property.bedrooms} Bedrooms`;
            actions.appendChild(bedrooms);
          }

          const detailsLink = document.createElement('a');
          detailsLink.href = property.details_url || '#';
          detailsLink.target = '_blank';
          detailsLink.rel = 'noopener';
          detailsLink.textContent = 'View details';
          actions.appendChild(detailsLink);

          card.append(title, meta, actions);
          elements.list.appendChild(card);
        });
      }

      const total = properties.length;
      const summaryText = total === 1 ? 'Showing 1 property' : `Showing ${total} properties`;
      elements.summary.textContent = summaryText;

      highlightActiveCard();
    }

    function refreshMarkers() {
      if (!state.mapReady) {
        return;
      }

      state.markers.forEach(({ marker }) => {
        if (!marker) {
          return;
        }

        if (state.mapLibrary === 'mapbox' && typeof marker.remove === 'function') {
          marker.remove();
        } else if (state.mapLibrary === 'leaflet') {
          if (typeof marker.remove === 'function') {
            marker.remove();
          } else if (state.map && typeof state.map.removeLayer === 'function') {
            state.map.removeLayer(marker);
          }
        }
      });
      state.markers.clear();

      const coords = [];

      state.filtered.forEach(property => {
        if (!isFinite(property.longitude) || !isFinite(property.latitude)) {
          return;
        }

        if (state.mapLibrary === 'mapbox') {
          const markerElement = document.createElement('div');
          markerElement.className = `marker ${property.category_key}`;
          markerElement.addEventListener('click', () => focusProperty(property.key, true));

          const marker = new mapboxgl.Marker({ element: markerElement, anchor: 'bottom' })
            .setLngLat([property.longitude, property.latitude])
            .setPopup(createMapboxPopup(property))
            .addTo(state.map);

          state.markers.set(property.key, { marker, property });
        } else if (state.mapLibrary === 'leaflet') {
          const marker = L.marker([property.latitude, property.longitude], {
            icon: L.divIcon({
              className: '',
              html: `<div class="marker ${property.category_key}"></div>`,
              iconSize: [32, 32],
              iconAnchor: [16, 32],
            }),
          });

          marker.on('click', () => focusProperty(property.key, true));
          marker.bindPopup(createLeafletPopup(property));
          marker.addTo(state.map);

          state.markers.set(property.key, { marker, property });
        }

        coords.push({ latitude: property.latitude, longitude: property.longitude });
      });

      updateViewport(coords);
    }

    function collectCoordinates() {
      return state.filtered
        .filter(property => isFinite(property.latitude) && isFinite(property.longitude))
        .map(property => ({ latitude: property.latitude, longitude: property.longitude }));
    }

    function updateViewport(coords) {
      if (!state.mapReady || !coords.length) {
        return;
      }

      if (state.mapLibrary === 'mapbox' && typeof mapboxgl !== 'undefined') {
        let bounds = null;
        coords.forEach(({ latitude, longitude }) => {
          const point = [longitude, latitude];
          if (!bounds) {
            bounds = new mapboxgl.LngLatBounds(point, point);
          } else {
            bounds.extend(point);
          }
        });

        if (bounds && typeof state.map.fitBounds === 'function') {
          state.map.fitBounds(bounds, { padding: 80, maxZoom: 14, duration: 800 });
        }
      } else if (state.mapLibrary === 'leaflet') {
        const latLngs = coords.map(({ latitude, longitude }) => [latitude, longitude]);
        if (latLngs.length === 1) {
          state.map.flyTo(latLngs[0], 13.5, { animate: true, duration: 0.8 });
        } else if (latLngs.length) {
          state.map.fitBounds(L.latLngBounds(latLngs), { padding: [40, 40], maxZoom: 14 });
        }
      }
    }

    function buildPopupContent(property) {
      const content = document.createElement('div');
      const title = document.createElement('h3');
      title.textContent = property.display_name;
      content.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'popup-meta';
      if (property.location) {
        const loc = document.createElement('span');
        loc.textContent = property.location;
        meta.appendChild(loc);
      }
      if (property.price) {
        const price = document.createElement('span');
        price.textContent = property.price;
        meta.appendChild(price);
      }
      if (property.bedrooms) {
        const beds = document.createElement('span');
        beds.textContent = `${property.bedrooms} Bedrooms`;
        meta.appendChild(beds);
      }
      content.appendChild(meta);

      const link = document.createElement('a');
      link.href = property.details_url || '#';
      link.target = '_blank';
      link.rel = 'noopener';
      link.textContent = 'Open property details';
      content.appendChild(link);

      return content;
    }

    function createMapboxPopup(property) {
      return new mapboxgl.Popup({ offset: 18, closeOnMove: true }).setDOMContent(buildPopupContent(property));
    }

    function createLeafletPopup(property) {
      return buildPopupContent(property).outerHTML;
    }

    function focusProperty(key, fromMarker = false) {
      state.activePropertyKey = key;
      highlightActiveCard();

      const markerData = state.markers.get(key);
      if (!markerData || !state.mapReady) {
        return;
      }

      const { property, marker } = markerData;

      if (state.mapLibrary === 'mapbox') {
        state.map.flyTo({ center: [property.longitude, property.latitude], zoom: 13.5, pitch: 50, bearing: -10, essential: true });
        if (!fromMarker) {
          const popup = marker.getPopup();
          if (popup) {
            popup.addTo(state.map);
          }
        }
      } else if (state.mapLibrary === 'leaflet') {
        state.map.flyTo([property.latitude, property.longitude], 13.5, { animate: true, duration: 0.8 });
        if (!fromMarker && typeof marker.openPopup === 'function') {
          marker.openPopup();
        }
      }
    }

    function highlightActiveCard() {
      const cards = elements.list.querySelectorAll('.property-card');
      cards.forEach(card => {
        card.dataset.active = card.dataset.key === state.activePropertyKey ? 'true' : 'false';
      });
    }

    function showOverlay(title, message) {
      elements.overlay.hidden = false;
      elements.overlay.querySelector('strong').textContent = title;
      elements.overlayDetails.textContent = message;
    }

    function hideOverlay() {
      elements.overlay.hidden = true;
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap"></script>
</body>
</html>
