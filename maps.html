<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>HouzzHunt Maps</title>
  <link rel="shortcut icon" href="assets/images/logo/favicon.png" type="image/x-icon">
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Hind+Madurai:wght@300;400;500;600;700&family=Lora:ital,wght@0,400..700;1,400..700&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap');

    :root {
      --tag-offplan: #0f635c;
      --tag-buy: #004a44;
      --tag-rent: #edbb68;
      --sidebar-width: 380px;
      --text-muted: #6f6f6f;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-size: 16px !important;
      font-family: "Hind Madurai", sans-serif !important;
      line-height: 1.4 !important;
      background: #f9f9f9;
      color: #0f635c;
    }

    a {
      color: inherit;
    }

    .heading-title>span {
      color: var(--uniqo-primary);
      font-family: "Lora", serif !important;
      font-style: italic;
      background: linear-gradient(97.08deg, #004a44 0%, #edbb68 55.06%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      font-weight: 300;
      display: inline-block;
      margin-bottom: 10px;
    }

    #map {
      position: fixed;
      top: 0;
      bottom: 0;
      width: 100%;
      z-index: 0;
    }

    #map.map-error-state {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f4f9f8;
    }

    #map.map-fallback-embed {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 18px;
      background: #f4f9f8;
      padding: 40px 32px 32px calc(var(--sidebar-width) + 32px);
      overflow-y: auto;
    }

    .map-fallback-message {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 24px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
      color: #0f635c;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-width: 520px;
    }

    .map-fallback-message strong {
      font-size: 18px;
    }

    .map-fallback-message span {
      font-size: 15px;
      color: var(--text-muted);
    }

    .map-fallback-frame {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
      overflow: hidden;
      width: min(720px, calc(100% - 24px));
      min-height: 360px;
    }

    .map-fallback-frame iframe {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }

    .map-fallback-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 24px;
      height: 100%;
      color: var(--text-muted);
      font-size: 15px;
    }

    .map-fallback-details {
      background: rgba(255, 255, 255, 0.88);
      border-radius: 14px;
      padding: 18px 22px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
      max-width: 520px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-fallback-property strong {
      font-size: 17px;
      color: #004a44;
    }

    .map-fallback-highlight {
      font-size: 15px;
      color: var(--text-muted);
    }

    .map-fallback-details .details-link {
      font-size: 14px;
      color: #004a44;
      text-decoration: none;
      font-weight: 600;
    }

    @media (max-width: 1024px) {
      #map.map-fallback-embed {
        padding: 24px;
      }

      .map-fallback-frame,
      .map-fallback-message,
      .map-fallback-details {
        max-width: 100%;
      }
    }

    @media (max-width: 768px) {
      #map.map-fallback-embed {
        position: static;
        width: 100%;
        order: 2;
        padding: 24px 16px 32px;
      }
    }

    .map-error-box {
      background: #fff6f5;
      border: 1px solid rgba(163, 58, 58, 0.35);
      color: #a33a3a;
      padding: 18px 22px;
      border-radius: 12px;
      max-width: 340px;
      width: calc(100% - 48px);
      text-align: center;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.1);
      font-size: 15px;
      line-height: 1.5;
    }

    .sidebar {
      position: absolute;
      z-index: 1;
      width: var(--sidebar-width);
      height: 100%;
      overflow-y: auto;
      background: #ffffff;
      color: #0f635c;
      padding: 24px 24px 32px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .logo-center {
      display: flex;
      width: 100%;
      align-items: center;
      gap: 18px;
    }

    .logo-center .home {
      width: 30px;
    }

    img.logo {
      width: 200px;
      margin-bottom: 0;
      position: relative;
      top: 4px;
    }

    .sidebar p.description {
      color: var(--text-muted);
      margin: 0;
      font-size: 15px;
    }

    input#searchInput {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d8d8d8;
      font-size: 15px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input#searchInput:focus {
      outline: none;
      border: 1px solid #0f635c;
      box-shadow: 0 0 0 3px rgba(15, 99, 92, 0.12);
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-btn {
      background: #004a44;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      letter-spacing: 0.2px;
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    .filter-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 74, 68, 0.18);
    }

    .filter-btn.active {
      background: #edbb68;
      color: #0f403b;
      box-shadow: 0 4px 10px rgba(237, 187, 104, 0.35);
    }

    #propertyList {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 24px;
    }

    .property-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 18px;
      border: 1px solid #e5e5e5;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }

    .property-card:hover {
      border-color: #0f635c;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .property-card.active {
      border-color: #edbb68;
      box-shadow: 0 10px 22px rgba(237, 187, 104, 0.25);
    }

    .property-title {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      color: #172b29;
      font-weight: 500;
      font-size: 16px;
    }

    .property-title span {
      flex: 1;
      line-height: 1.4;
    }

    .tag {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      color: #ffffff;
      white-space: nowrap;
    }

    .tag-offplan {
      background: var(--tag-offplan);
    }

    .tag-buy {
      background: var(--tag-buy);
    }

    .tag-rent {
      background: var(--tag-rent);
      color: #2f2810;
    }

    .property-meta {
      font-size: 14px;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
    }

    .property-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .property-meta strong {
      color: #0f403b;
      font-weight: 600;
    }

    .details-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #004a44;
      text-decoration: none;
      margin-top: 4px;
      font-weight: 600;
    }

    .details-link:hover {
      text-decoration: underline;
    }

    .empty-state,
    .error-state,
    .loading-state {
      padding: 16px;
      border-radius: 12px;
      background: #f4f9f8;
      color: var(--text-muted);
      font-size: 15px;
      border: 1px dashed rgba(15, 99, 92, 0.25);
    }

    .error-state {
      background: #fff6f5;
      color: #a33a3a;
      border-color: rgba(163, 58, 58, 0.35);
    }

    .loading-state {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .loading-spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(15, 99, 92, 0.15);
      border-top-color: var(--tag-offplan);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .map-legend {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 13px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    /* Thin Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #edbb68;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #edbb68;
    }

    @media(max-width: 992px) {
      :root {
        --sidebar-width: 100%;
      }

      .sidebar {
        position: relative;
        width: 100%;
        height: auto;
        padding-bottom: 24px;
      }

      #map {
        position: relative;
        width: 100%;
        height: 65vh;
      }
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <div class="logo-center">
      <a href="index.php">
        <img src="assets/home.png" alt="Back to home" class="home">
      </a>
      <img src="assets/images/logo/green-logo.svg" alt="HouzzHunt Logo" class="logo" />
    </div>
    <h2 class="heading-title"><span class="whiteYellow">Explore Dubai with HouzzHunt</span></h2>
    <p class="description">Discover every HouzzHunt property at a glance. Filter between Off-Plan launches, ready-to-buy homes,
      and curated rentals to find the perfect match for your lifestyle.</p>
    <input type="text" id="searchInput" placeholder="Search properties or communities..." oninput="searchProperties(this.value)">
    <div class="filters">
      <button class="filter-btn active" data-filter="all" onclick="filterBy('all', this)">All</button>
      <button class="filter-btn" data-filter="offplan" onclick="filterBy('offplan', this)">Off-Plan</button>
      <button class="filter-btn" data-filter="buy" onclick="filterBy('buy', this)">Buy</button>
      <button class="filter-btn" data-filter="rent" onclick="filterBy('rent', this)">Rent</button>
    </div>
    <div class="map-legend">
      <span class="legend-item"><span class="legend-dot" style="background: var(--tag-offplan);"></span>Off-Plan</span>
      <span class="legend-item"><span class="legend-dot" style="background: var(--tag-buy);"></span>Buy</span>
      <span class="legend-item"><span class="legend-dot" style="background: var(--tag-rent);"></span>Rent</span>
    </div>
    <div id="propertyList">
      <div class="loading-state"><span class="loading-spinner" aria-hidden="true"></span>Loading properties...</div>
    </div>
  </div>
  <div id="map" role="presentation"></div>
  <script>
    const propertyState = {
      all: [],
      filtered: [],
      activeFilter: 'all',
      searchTerm: '',
      markerData: new Map(),
      markers: [],
      selectedKey: null,
    };

    let map;
    let geocoder;
    let infoWindow;
    let googleMapsScriptPromise = null;
    let fallbackMode = false;
    let fallbackEmbedFrame = null;
    let fallbackDetailsContainer = null;
    const defaultMapCenter = { lat: 25.2048, lng: 55.2708 };

    function propertyKey(property) {
      return `${property.category_key}:${property.id}`;
    }

    function escapeHtml(value) {
      if (typeof value !== 'string') {
        return '';
      }

      return value.replace(/[&<>"']/g, (match) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      })[match]);
    }

    function sanitiseUrl(url) {
      if (typeof url !== 'string' || url.trim() === '') {
        return '#';
      }

      try {
        const absolute = new URL(url, window.location.origin);
        return absolute.pathname + absolute.search + absolute.hash;
      } catch (error) {
        return '#';
      }
    }

    function displayMapError(message) {
      const mapElement = document.getElementById('map');
      if (!mapElement) {
        return;
      }

      const safeMessage = escapeHtml(String(message || ''));
      mapElement.classList.add('map-error-state');
      mapElement.innerHTML = `<div class="map-error-box">${safeMessage}</div>`;
    }

    function activateEmbedFallback(properties) {
      fallbackMode = true;

      const mapElement = document.getElementById('map');
      if (!mapElement) {
        return;
      }

      mapElement.classList.remove('map-error-state');
      mapElement.classList.add('map-fallback-embed');
      mapElement.innerHTML = `
        <div class="map-fallback-message">
          <strong>Interactive Google Map unavailable</strong>
          <span>Configure your Google Maps API key or retry once connectivity is restored to unlock the live property explorer. Until then, preview the Prime Location &amp; Connectivity map for each listing below.</span>
        </div>
        <div class="map-fallback-frame"></div>
        <div class="map-fallback-details"></div>
      `;

      fallbackEmbedFrame = mapElement.querySelector('.map-fallback-frame');
      fallbackDetailsContainer = mapElement.querySelector('.map-fallback-details');
      clearMarkers();

      const firstCandidate = Array.isArray(properties)
        ? properties.find((property) => property && property.location_embed_url) || properties[0] || null
        : null;
      updateFallbackEmbed(firstCandidate);
    }

    function updateFallbackEmbed(property) {
      if (!fallbackMode) {
        return;
      }

      if (!fallbackEmbedFrame || !fallbackDetailsContainer) {
        return;
      }

      if (!property) {
        fallbackEmbedFrame.innerHTML = '<div class="map-fallback-placeholder">Select a property from the list to view its Prime Location &amp; Connectivity preview.</div>';
        fallbackDetailsContainer.innerHTML = '';
        return;
      }

      const safeName = escapeHtml(property.display_name || property.title || 'Property');
      const highlight = property.location_highlight || property.location || '';

      if (property.location_embed_url) {
        const safeSrc = escapeHtml(property.location_embed_url);
        fallbackEmbedFrame.innerHTML = `<iframe src="${safeSrc}" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
      } else if (property.location) {
        const fallbackUrl = `https://www.google.com/maps?q=${encodeURIComponent(property.location)}&output=embed`;
        fallbackEmbedFrame.innerHTML = `<iframe src="${fallbackUrl}" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
      } else {
        fallbackEmbedFrame.innerHTML = '<div class="map-fallback-placeholder">A map preview is not available for this property yet.</div>';
      }

      const highlightHtml = highlight ? `<span class="map-fallback-highlight">${escapeHtml(highlight)}</span>` : '';
      const detailsHref = sanitiseUrl(property.details_url);
      fallbackDetailsContainer.innerHTML = `
        <div class="map-fallback-property">
          <strong>${safeName}</strong>
          ${highlightHtml}
          <a class="details-link" href="${detailsHref}">View property details</a>
        </div>
      `;
    }

    function renderSidebar(list) {
      const container = document.getElementById('propertyList');
      container.innerHTML = '';

      if (!Array.isArray(list) || list.length === 0) {
        container.innerHTML = '<div class="empty-state">No properties match your filters yet. Try adjusting the search or filter to explore more options.</div>';
        return;
      }

      list.forEach((property) => {
        const key = propertyKey(property);
        const card = document.createElement('div');
        card.className = 'property-card';
        card.dataset.propertyKey = key;
        card.innerHTML = `
          <div class="property-title">
            <span>${escapeHtml(property.display_name || property.title)}</span>
            <span class="tag tag-${property.category_key}">${escapeHtml(property.category_label)}</span>
          </div>
          <div class="property-meta">
            ${property.location ? `<span><strong>Location:</strong> ${escapeHtml(property.location)}</span>` : ''}
            ${property.property_type ? `<span><strong>Type:</strong> ${escapeHtml(property.property_type)}</span>` : ''}
            ${property.bedrooms ? `<span><strong>Bedrooms:</strong> ${escapeHtml(property.bedrooms)}</span>` : ''}
            ${property.price ? `<span><strong>Price:</strong> ${escapeHtml(property.price)}</span>` : ''}
          </div>
          <a class="details-link" href="${sanitiseUrl(property.details_url)}">View details</a>
        `;

        card.addEventListener('click', (event) => {
          if (event.target.closest('a')) {
            return;
          }

          focusProperty(property, card);
        });

        if (propertyState.selectedKey === key) {
          card.classList.add('active');
        }

        container.appendChild(card);
      });
    }

    function setActiveCard(cardElement) {
      document.querySelectorAll('.property-card.active').forEach((activeCard) => {
        activeCard.classList.remove('active');
      });

      if (cardElement) {
        cardElement.classList.add('active');
      }
    }

    function filterBy(filterKey, buttonElement) {
      propertyState.activeFilter = filterKey;
      document.querySelectorAll('.filter-btn').forEach((button) => button.classList.remove('active'));
      if (buttonElement) {
        buttonElement.classList.add('active');
      }
      applyFilters();
    }

    function searchProperties(keyword) {
      propertyState.searchTerm = typeof keyword === 'string' ? keyword.trim().toLowerCase() : '';
      applyFilters();
    }

    function applyFilters() {
      const { activeFilter, searchTerm } = propertyState;
      const filtered = propertyState.all.filter((property) => {
        const matchesFilter = activeFilter === 'all' || property.category_key === activeFilter;
        if (!matchesFilter) {
          return false;
        }

        if (searchTerm === '') {
          return true;
        }

        const haystack = [property.display_name, property.title, property.location, property.property_type]
          .filter(Boolean)
          .join(' ')
          .toLowerCase();

        return haystack.includes(searchTerm);
      });

      propertyState.filtered = filtered;
      renderSidebar(filtered);
      updateMarkers(filtered);

      if (fallbackMode) {
        const candidate = filtered.find((property) => property.location_embed_url) || filtered[0] || null;
        updateFallbackEmbed(candidate);
      }
    }

    function fetchPropertiesData() {
      const container = document.getElementById('propertyList');

      return fetch('property-map-data.php', {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
        },
        credentials: 'same-origin',
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`Request failed with status ${response.status}`);
          }
          return response.json();
        })
        .then((payload) => {
          if (!payload || !Array.isArray(payload.properties)) {
            throw new Error('Unexpected response structure');
          }

          propertyState.all = payload.properties;
          propertyState.selectedKey = null;
          applyFilters();

          return payload;
        })
        .catch((error) => {
          console.error('Failed to load property data', error);
          if (container) {
            container.innerHTML = '<div class="error-state">We were unable to load property data at the moment. Please refresh the page or try again later.</div>';
          }
          propertyState.all = [];
          propertyState.filtered = [];
          clearMarkers();

          throw error;
        });
    }

    function ensurePosition(property) {
      if (property.position && typeof property.position.lat === 'number' && typeof property.position.lng === 'number') {
        return Promise.resolve(property.position);
      }

      if (typeof property.latitude === 'number' && typeof property.longitude === 'number') {
        property.position = { lat: property.latitude, lng: property.longitude };
        return Promise.resolve(property.position);
      }

      if (!geocoder || !property.location) {
        return Promise.resolve(null);
      }

      if (!property.geocodePromise) {
        property.geocodePromise = new Promise((resolve) => {
          geocoder.geocode({ address: property.location }, (results, status) => {
            if (status === 'OK' && results && results[0]) {
              const location = results[0].geometry.location;
              property.position = { lat: location.lat(), lng: location.lng() };
              resolve(property.position);
            } else {
              console.warn('Geocode failed for property', property, status);
              resolve(null);
            }
          });
        });
      }

      return property.geocodePromise;
    }

    function getMarkerStyle(categoryKey) {
      const styles = {
        offplan: { fillColor: '#0f635c', strokeColor: '#0b413c' },
        buy: { fillColor: '#004a44', strokeColor: '#002f2b' },
        rent: { fillColor: '#edbb68', strokeColor: '#c9963d' },
      };

      return styles[categoryKey] || styles.buy;
    }

    function createMarker(property, position) {
      const style = getMarkerStyle(property.category_key);
      const marker = new google.maps.Marker({
        position,
        map,
        title: property.display_name || property.title,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 9,
          fillColor: style.fillColor,
          fillOpacity: 0.95,
          strokeColor: style.strokeColor,
          strokeOpacity: 0.9,
          strokeWeight: 2,
        },
      });

      marker.addListener('click', () => {
        window.location.href = sanitiseUrl(property.details_url);
      });

      marker.addListener('mouseover', () => {
        showInfoWindow(property, marker);
      });

      marker.addListener('mouseout', () => {
        hideInfoWindow();
      });

      return marker;
    }

    function showInfoWindow(property, marker) {
      if (!infoWindow) {
        infoWindow = new google.maps.InfoWindow();
      }

      const content = `
        <div style="min-width:200px;max-width:240px;font-family:'Hind Madurai',sans-serif;">
          <div style="font-weight:600;font-size:15px;margin-bottom:6px;color:#0f403b;">${escapeHtml(property.display_name || property.title)}</div>
          ${property.location ? `<div style=\"font-size:13px;color:#5a5a5a;margin-bottom:4px;\">${escapeHtml(property.location)}</div>` : ''}
          ${property.price ? `<div style=\"font-size:13px;color:#5a5a5a;margin-bottom:6px;\"><strong style=\"color:#0f635c;\">Price:</strong> ${escapeHtml(property.price)}</div>` : ''}
          <div>
            <a href="${sanitiseUrl(property.details_url)}" style="font-size:13px;color:#004a44;font-weight:600;text-decoration:none;">View details</a>
          </div>
        </div>`;

      infoWindow.setContent(content);
      infoWindow.open({ anchor: marker, map, shouldFocus: false });
    }

    function hideInfoWindow() {
      if (infoWindow) {
        infoWindow.close();
      }
    }

    function clearMarkers() {
      if (fallbackMode) {
        propertyState.markers = [];
        propertyState.markerData.clear();
        return;
      }

      propertyState.markers.forEach((marker) => marker.setMap(null));
      propertyState.markers = [];
      propertyState.markerData.clear();
    }

    function updateMarkers(properties) {
      if (fallbackMode) {
        propertyState.markerData.clear();
        propertyState.markers = [];
        return;
      }

      if (!map) {
        return;
      }

      clearMarkers();
      const creationPromises = properties.map((property) => ensurePosition(property).then((position) => {
        if (!position) {
          return null;
        }
        const marker = createMarker(property, position);
        const key = propertyKey(property);
        propertyState.markers.push(marker);
        propertyState.markerData.set(key, { marker, property, position });
        return marker;
      }));

      Promise.all(creationPromises).then((results) => {
        const validMarkers = results.filter(Boolean);
        if (validMarkers.length === 0) {
          map.setCenter(defaultMapCenter);
          map.setZoom(11);
          return;
        }

        const bounds = new google.maps.LatLngBounds();
        validMarkers.forEach((marker) => {
          const pos = marker.getPosition();
          if (pos) {
            bounds.extend(pos);
          }
        });

        try {
          map.fitBounds(bounds);
        } catch (error) {
          console.warn('Unable to fit bounds', error);
        }
      });
    }

    function focusProperty(property, cardElement) {
      const key = propertyKey(property);
      propertyState.selectedKey = key;
      setActiveCard(cardElement);

      if (fallbackMode) {
        updateFallbackEmbed(property);
        return;
      }

      const markerInfo = propertyState.markerData.get(key);
      if (markerInfo) {
        map.panTo(markerInfo.position);
        map.setZoom(Math.max(map.getZoom(), 14));
        showInfoWindow(property, markerInfo.marker);
        return;
      }

      ensurePosition(property).then((position) => {
        if (!position) {
          return;
        }
        map.panTo(position);
        map.setZoom(Math.max(map.getZoom(), 14));
      });
    }

    function loadGoogleMaps(apiKey) {
      if (googleMapsScriptPromise) {
        return googleMapsScriptPromise;
      }

      googleMapsScriptPromise = new Promise((resolve, reject) => {
        if (window.google && window.google.maps) {
          initMap();
          resolve();
          return;
        }

        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}`;
        script.async = true;
        script.defer = true;

        script.onload = () => {
          if (window.google && window.google.maps) {
            initMap();
            resolve();
          } else {
            reject(new Error('Google Maps API unavailable.'));
          }
        };

        script.onerror = () => reject(new Error('Failed to load Google Maps script.'));
        document.head.appendChild(script);
      }).catch((error) => {
        console.error('Unable to initialise Google Maps', error);
        if (!fallbackMode) {
          activateEmbedFallback(propertyState.all);
        } else {
          displayMapError('We were unable to load Google Maps at the moment. Please try again later.');
        }
        throw error;
      });

      return googleMapsScriptPromise;
    }

    function initMap() {
      if (map) {
        updateMarkers(propertyState.filtered);
        return;
      }

      const mapElement = document.getElementById('map');
      if (!mapElement) {
        return;
      }

      mapElement.classList.remove('map-error-state');
      mapElement.innerHTML = '';

      map = new google.maps.Map(mapElement, {
        center: defaultMapCenter,
        zoom: 11,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
        clickableIcons: true,
        styles: [
          {
            featureType: 'poi',
            stylers: [{ visibility: 'off' }],
          },
          {
            featureType: 'road',
            elementType: 'labels.icon',
            stylers: [{ visibility: 'off' }],
          },
        ],
      });

      geocoder = new google.maps.Geocoder();
      infoWindow = new google.maps.InfoWindow();
      updateMarkers(propertyState.filtered);
    }

    function bootstrapMapExperience() {
      fetchPropertiesData()
        .then((payload) => {
          const apiKey = typeof payload.google_maps_api_key === 'string' ? payload.google_maps_api_key.trim() : '';
          if (apiKey === '') {
            activateEmbedFallback(payload.properties);
            return null;
          }

          return loadGoogleMaps(apiKey);
        })
        .catch((error) => {
          console.error('Failed to bootstrap the map experience', error);
        });
    }

    bootstrapMapExperience();

    window.initMap = initMap;
    window.filterBy = filterBy;
    window.searchProperties = searchProperties;
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap"></script>
</body>

</html>
